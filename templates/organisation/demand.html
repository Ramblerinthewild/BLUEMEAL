{% extends "organisation/base_org.html" %}
{% block content %}

<h2>Meal Demand</h2>

<div class="calendar-header">
    <button id="prevMonth">◀</button>
    <h3 id="monthLabel"></h3>
    <button id="nextMonth">▶</button>
</div>

<div class="calendar" id="calendar"></div>

<div class="overlay" id="overlay">
    <div class="modal">
        <h3 id="selectedDate"></h3>

        <div id="results"></div>
    </div>
</div>

<style>
.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-top: 20px;
}

.day {
    padding: 15px;
    border: 1px solid #ccc;
    cursor: pointer;
    text-align: center;
}

.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
}

.modal {
    background: white;
    padding: 25px;
    width: 60%;
    max-height: 80%;
    overflow-y: auto;
    border-radius: 10px;
}

.bar {
    background: #eee;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 8px;
}

.fill {
    background: #4CAF50;
    color: white;
    padding: 6px;
    white-space: nowrap;
}
</style>

<script>
let currentDate = new Date();
const calendar = document.getElementById("calendar");
const monthLabel = document.getElementById("monthLabel");
const overlay = document.getElementById("overlay");
const results = document.getElementById("results");
const selectedDateText = document.getElementById("selectedDate");

function renderCalendar() {
    calendar.innerHTML = "";

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    monthLabel.innerText = currentDate.toLocaleString("default", {
        month: "long",
        year: "numeric"
    });

    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let day = 1; day <= daysInMonth; day++) {
        const div = document.createElement("div");
        div.className = "day";
        div.innerText = day;

        div.ondblclick = async () => {
            // Format date properly with zero-padding
            const monthNum = String(month + 1).padStart(2, '0');
            const dayNum = String(day).padStart(2, '0');
            const date = `${year}-${monthNum}-${dayNum}`;
            
            selectedDateText.innerText = date;

            const res = await fetch(`/organisation/demand-data?date=${date}`);
            const data = await res.json();

            results.innerHTML = "";

            // Check if there's any data
            let hasData = false;
            for (const meal in data) {
                if (Object.keys(data[meal]).length > 0) {
                    hasData = true;
                    break;
                }
            }

            if (!hasData) {
                results.innerHTML = "<p style='color: #999;'>No student selections for this date yet.</p>";
                overlay.style.display = "flex";
                return;
            }

            for (const meal in data) {
                if (Object.keys(data[meal]).length === 0) continue;
                
                results.innerHTML += `<h4 style='margin-top: 20px; margin-bottom: 10px;'>${meal.toUpperCase()}</h4>`;

                for (const item in data[meal]) {
                    const percent = data[meal][item];
                    results.innerHTML += `
                        <div style='margin-bottom: 15px;'>
                            <div style='margin-bottom: 5px;'><strong>${item}</strong>: ${percent}% of students</div>
                            <div class="bar">
                                <div class="fill" style="width:${percent}%">
                                    ${percent}%
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            overlay.style.display = "flex";
        };

        calendar.appendChild(div);
    }
}

overlay.onclick = e => {
    if (e.target === overlay) overlay.style.display = "none";
};

document.getElementById("prevMonth").onclick = () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};

document.getElementById("nextMonth").onclick = () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};

renderCalendar();
</script>

{% endblock %}
