{% extends "organisation/base_org.html" %}

{% block content %}

<!-- Calendar header -->
<div class="calendar-header">
    <button id="prevMonth">◀</button>
    <h2 id="monthLabel"></h2>
    <button id="nextMonth">▶</button>
</div>

<!-- Calendar grid -->
<div class="calendar" id="calendar"></div>

<!-- Overlay modal -->
<div class="overlay" id="overlay">
    <div class="modal" id="modal">
        <h3 id="selectedDate">Selected date</h3>
        
        <div class="meal-section">
            <h4>Breakfast</h4>
            <div class="items" id="breakfastItems"></div>
        </div>
        
        <div class="meal-section">
            <h4>Lunch</h4>
            <div class="items" id="lunchItems"></div>
        </div>
        
        <div class="meal-section">
            <h4>Dinner</h4>
            <div class="items" id="dinnerItems"></div>
        </div>

        <button id="saveSelectionBtn">Save Selection</button>
    </div>
</div>

<style>
.calendar-header { display:flex; align-items:center; gap:20px; }
.calendar { margin-top:20px; display:grid; grid-template-columns:repeat(7,1fr); gap:10px; }
.meal-section { margin-bottom:20px; }
.items div { 
    padding:8px 12px; 
    background:#f2f2f2; 
    margin-bottom:6px; 
    border-radius:4px; 
    cursor:pointer; 
    transition: all 0.2s;
}
.items div:hover { background:#e0e0e0; }
.items div.selected { 
    background:#4CAF50; 
    color: white;
    font-weight: bold;
}
.day { padding:15px; border:1px solid #ddd; cursor:pointer; text-align:center; border-radius:4px; }
.day:hover { background:#f2f2f2; }
.overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal { background:white; padding:30px; border-radius:10px; width:60%; max-height:80%; overflow-y:auto; }
#saveSelectionBtn { 
    margin-top:20px; 
    padding:12px 24px; 
    border:none; 
    background:#4CAF50; 
    color:white; 
    border-radius:5px; 
    cursor:pointer; 
    font-size:16px;
    width:100%;
}
#saveSelectionBtn:hover {
    background:#45a049;
}
.info-text {
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
}
</style>

<script>
let currentDate = new Date();
let selectedDate = null;

// Holds selected items for this modal
let selectedMeals = { breakfast: [], lunch: [], dinner: [] };

const calendar = document.getElementById("calendar");
const monthLabel = document.getElementById("monthLabel");
const overlay = document.getElementById("overlay");
const selectedDateText = document.getElementById("selectedDate");

function renderCalendar() {
    calendar.innerHTML = "";
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    monthLabel.innerText = currentDate.toLocaleString("default", { month: "long", year: "numeric" });

    for(let i=0; i<firstDay; i++) calendar.appendChild(document.createElement("div"));

    for(let day=1; day<=daysInMonth; day++){
        const cell = document.createElement("div");
        cell.className = "day";
        cell.innerText = day;

        cell.ondblclick = async () => {
            // Fix date formatting with zero-padding
            const monthNum = String(month + 1).padStart(2, '0');
            const dayNum = String(day).padStart(2, '0');
            selectedDate = `${year}-${monthNum}-${dayNum}`;
            selectedDateText.innerText = selectedDate;

            // Fetch existing menu for this date
            const response = await fetch(`/student/menu?date=${selectedDate}`);
            const data = await response.json();

            // Check if there's a menu
            const hasMenu = data.breakfast.length > 0 || data.lunch.length > 0 || data.dinner.length > 0;
            
            if (!hasMenu) {
                alert("No menu available for this date yet. Please check with your school administrator.");
                return;
            }

            selectedMeals = { breakfast: [], lunch: [], dinner: [] };

            // Populate UI
            ["breakfast","lunch","dinner"].forEach(meal => {
                const container = document.getElementById(meal+"Items");
                container.innerHTML = "";
                
                if (data[meal].length === 0) {
                    container.innerHTML = "<p style='color:#999;'>No items available</p>";
                    return;
                }
                
                data[meal].forEach(item => {
                    const div = document.createElement("div");
                    div.innerText = item;
                    div.onclick = () => toggleSelect(meal, item, div);
                    container.appendChild(div);
                });
            });

            overlay.style.display = "flex";
        };

        calendar.appendChild(cell);
    }
}

function toggleSelect(meal, item, div){
    const index = selectedMeals[meal].indexOf(item);
    if(index === -1){
        selectedMeals[meal].push(item);
        div.classList.add("selected");
    } else {
        selectedMeals[meal].splice(index,1);
        div.classList.remove("selected");
    }
}

document.getElementById("saveSelectionBtn").onclick = async () => {
    if(!selectedDate) return;
    
    // Check if any selections were made
    const totalSelections = selectedMeals.breakfast.length + selectedMeals.lunch.length + selectedMeals.dinner.length;
    if (totalSelections === 0) {
        alert("Please select at least one item before saving.");
        return;
    }
    
    try {
        const response = await fetch("/student/select", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date: selectedDate, meals: selectedMeals })
        });
        
        const result = await response.json();
        
        if (result.status === "saved") {
            alert("Your meal selections have been saved!");
            overlay.style.display = "none";
        } else {
            alert("Error saving selections: " + (result.error || "Unknown error"));
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Network error. Please try again.");
    }
};

// Close modal when clicking outside (but not the button)
overlay.onclick = (e) => {
    if(e.target === overlay) {
        overlay.style.display="none";
    }
};

document.getElementById("prevMonth").onclick = () => { 
    currentDate.setMonth(currentDate.getMonth()-1); 
    renderCalendar(); 
};

document.getElementById("nextMonth").onclick = () => { 
    currentDate.setMonth(currentDate.getMonth()+1); 
    renderCalendar(); 
};

renderCalendar();
</script>

{% endblock %}